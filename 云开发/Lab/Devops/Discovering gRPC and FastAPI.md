
## 1 Introduction

The goal of this very short lab is to make you discover two communication abstractions: RPC and REST. For each of these two abstractions, you will implement a simple hello world service.

In the text that follows, the instructions assume that you are using the text editor you want (vi, gedit, â€¦) and that you are running the commands from a shell. Very quickly, you will be required to use a tool, called `vscode` (Visual Studio Code) which is already installed on your VDI VMs. So you can already decide to start using `vscode` instead of a basic editor like vi or gedit.

In short, for this lab, you are free to use what you want. From next week on, you will have to use `vscode`.

## 2 Hello Service with gRPC

### 2.1 Installing the gRPC Framework

Execute the following commands to 1) install and use a recent version of `python3`, 

1. create and activate a virtual environment for the work that you will do from now on
2. install the packages required for using **gRPC** with the Python language.

```
> pyenv update
> pyenv install 3.11.1
> pyenv global 3.11.1
> pyenv virtualenv 3.11.1 devops.env
> pyenv activate devops.env
> pip install grpcio
> pip install grpcio-tools
```

### 2.2 The Hello gRPC Service

The `Hello` gRPC service is very simple. It offers a `sayHello` operation that takes a `HelloRequest` message and returns a `HelloReply` message. The service is described in a `.proto` file (**protocol buffer** data serialization format defined by Google):

```
syntax = "proto3";

service Hello {
  rpc sayHello (HelloRequest) returns (HelloReply);
}

message HelloRequest {
  string name = 1;
}

message HelloReply {
  string message = 1;
}
```

Execute the following commands to download the `Hello` gRPC service definition:

```
(devops.env) cd location_of_your_git_repo
(devops.env) mkdir grpc-hello-service
(devops.env) cd grpc-hello-service
(devops.env) mkdir proto
(devops.env) cd proto
(devops.env) wget http://www.cloud.rennes.enst-bretagne.fr/files/grpc-lab/hello-service/proto/hello.proto
(devops.env) chmod 744 hello.proto
```

The `proto` file contains a description of the service which is a kind of contract between the server and the client. The server must implement the procedures listed in the contract. The client relies on the contract to determine the services it may request to the server.

To help the server (in fact, the programmer of the server) provide an implementation of the contract, a stub generator is used. Thanks to this stub generator, a class is generated on the server side. This class will be used as a base class for the class defining the contract procedures. On the client side, a class is also generated by the stub generator. The interface of this class will mimic the server interface, making it very simple to invoke the procedures implemented by the remote server.

Execute the following commands to generate the stub (also called helper) classes for both client and server:

```
(devops.env) cd grpc-hello-service
(devops.env) python3 -m grpc_tools.protoc -Iproto --python_out=. --grpc_python_out=. proto/hello.proto
```

After running the stubs generator, two files must have been generated:

- `hello_pb2.py` which contains the **python** classes mapping the **proto** messages to the **python** language.
- `hello_pb2_grpc.py` which contains the **python** helper classes for the server (`HelloServicer`) and for the client (`HelloStub`).

Execute the following commands to download 1) the `Hello` service implementation and 2) a very simple client of the `Hello` service.

```
(devops.env) cd location_of_your_git_repo
(devops.env) cd grpc-hello-service
(devops.env) wget http://www.cloud.rennes.enst-bretagne.fr/files/grpc-lab/hello-service/hello_service.py
(devops.env) wget http://www.cloud.rennes.enst-bretagne.fr/files/grpc-lab/hello-service/hello_client.py
(devops.env) chmod 744 hello_service.py
(devops.env) chmod 744 hello_client.py
```

Please examine the server (`hello_service.py`) and client (`hello_client.py`) source code to find out how they use the helper classes generated by the stubs generator.

Run the server in a shell Terminal and the client in another Terminal. The client should normally call the RPC procedure of the contract implemented by the server.

## 3 Hello Service with FastAPI

### 3.1 Installing the FastAPI Framework

The `Hello` service exposes a **REST** API. It is implemented using **FastAPI** (see [https://fastapi.tiangolo.com](https://fastapi.tiangolo.com/)) Before running the service, you must install a python package on your local VM.

Execute the following command to install the packages required by the `Hello` service (make sure you activated your virtual python environment before running `pip`).

```
(devops.env) > pip install fastapi[all]
```

### 3.2 The Hello FastAPI Service

This `Hello` service is very simple: it handles GET requests for the `hello` endpoint and returns a "hello" string in a JSON document.

Execute the following commands to download the source code the `Hello` service in the `hello` directory of your git repository

```
(devops.env) cd location_of_your_git_repo
(devops.env) mkdir fastapi-hello-service
(devops.env) cd fastapi-hello-service
(devops.env) wget http://www.cloud.rennes.enst-bretagne.fr/files/rest-lab/hello-service/hello_service.py
(devops.env) chmod 744 hello_service.py
```

Go to the `hello` directory and run the service using the following command:

```
(dev.env) ./hello_service.py
```

If everything goes well, the `Hello` service should be running and waiting for requests from clients on port `8000` at `localhost`.

By using the `curl` command, try to execute a `GET` call to the `hello` endpoint. Note that you can use the `-v` option to `curl` to see the headers. If you are annoyed by the lack of a trailing newline after the HTTP response for a curl request, create a `~/.curlrc` file with the following content `-w "\n"`.

You may also use the **SwaggerUI** interface to visualize and interact with your resources. The interface is automatically generated from your FastAPI implementation.

Start a Web browser and type the following address http://127.0.0.1:8000/docs in the address bar to reach the SwaggerUI to your `hello`service.

Use the Swagger interface to explore the `Hello` service API and access the associated method.

Add an endpoint, `/hello/{firstname}?level=somevalue` (`firstname` being a path parameter, a variable part of the URL and `level` being a query parameter indicating if the client is expecting a formal response or a familiar one) and define a new method in the `hello_service.py` file to handle a GET request to this new endpoint. The response to be returned must be a JSON document with key `message` and value `hello, {firstname}` if `level` equals to `familiar` or `Nice to meet you, {firstname}`if `level` equals to `formal`. Think about the best response to return if `level` is neither `familiar` nor `formal`.

